# 内网穿透与代理

### 内网穿透

内网穿透的核心原理在于**将外网 IP 地址与内网 IP 地址建立联系**。

​		内网穿透是一种技术，用于将内部网络中的服务映射到公网上，使外部网络可以访问内部网络资源。具体来说，<u>内网穿透技术可以将内部网络的IP地址和端口号映射到公网的IP地址上，使得外部网络可以通过这个公网的IP地址和端口号访问到内部网络的服务</u>。

​		内网穿透的实现方式有多种，包括**端口映射、反向代理和虚拟专用网络（VPN）**等。其中，**端口映射**是最常见的方式，它通过路由器或防火墙将内部网络的IP地址和端口号映射到公网的IP地址和端口号上。**反向代理**则是将外部网络对内部网络服务的请求转发到内部网络中，然后将内部网络服务的响应返回给外部网络。**VPN**则是通过加密通道将内部网络和外部网络连接起来，使得内部网络和外部网络可以安全地进行通信。

注：[反向代理 | Project X (xtls.github.io)](https://xtls.github.io/config/reverse.html#portalobject)



#### 内网环境

IP，网关，DNS，外网，端口，本机host文件，域。



##### IP（Internet Protocol）：

- IP 是一种用于网络通信的协议。它可以给每一台在互联网上的电脑赋予一个独特的地址，称为 IP 地址。这个地址由四个数字组成，用点分隔开，例如：192.168.1.1。
- IPv4和IPv6。

##### 网关（Gateway）：

- 网关是网络连接设备，它允许数据从一个网络传输到另一个网络。它通常用于连接内部网络（如公司或家庭网络）和外部网络（如互联网）。

##### DNS（Domain Name System）：

- DNS 是一个将域名转换为 IP 地址的系统。例如，当你在浏览器中输入网址时，DNS 会将这个网址转换为相应的 IP 地址。

##### 外网（WAN, Wide Area Network）：

- 外网通常是指与外部通信的大型网络，如互联网。外网可以由许多不同的设备、电脑、服务器等组成，并使用各种不同的协议和技术进行通信。

##### 端口（Port）：

- 端口是计算机网络中用于识别不同服务的号码。当数据发送到某个端口时，相应的服务会接收并处理这些数据。

##### 本机host文件（Host File）：

- 本机host文件是一个存储IP地址和域名对应关系的本地文件。它允许用户通过域名访问互联网上的网站和服务，而不是通过IP地址。

##### 域（Domain）：

- 域在网络中通常是指一个统一的网络环境，其中包含了所有共享特定属性的用户、计算机和工作组。在DNS中，域指的是一个统一的命名空间，它由许多相关的主机名和域名组成。



NAT：将内网与外网隔离。



#### 网络协议类型

TCP与UDP



#### NAT

​		NAT（Network Address Translation）是一种网络地址转换技术，用于将私有IP地址转换为公共IP地址，以便私有网络中的设备能够访问互联网。<u>NAT通过将私有IP地址和端口号映射到公共IP地址和端口号上，实现了内部网络和外部网络的通信。</u>

​		NAT有几种类型，包括**静态NAT、动态NAT和NAPT（Network Address Port Translation）**。**静态NAT**将一个私有IP地址静态映射到一个公共IP地址上，而**动态NAT**则是将多个私有IP地址动态映射到一个公共IP地址上。**NAPT**则将多个私有IP地址和端口号映射到一个公共IP地址和端口号上，允许多个内部网络设备使用相同的公网地址和端口号进行通信。

​		NAT的主要优点包括隐藏内部网络地址、缓解IP地址耗尽的问题、提高网络安全性和减少公网IP地址的需求。然而，NAT也存在一些问题，如可能导致通信延迟、无法支持一些特定的网络协议和限制了内部网络设备的直接通信能力。



**cone类型**：指NAT设备将来自相同内部IP地址和端口的请求映射到相同的外部IP地址和端口，但只有当内部主机先给某个外部主机发送IP包时，该外部主机才能向该内部主机发送IP包。这种类型的NAT限制了外部主机主动与内部主机通信的能力。

**symmetric类型**：它是一种比所有Cone类型更为灵活的转换方式。在Cone类型中，内部主机的内部Tuple与外部Tuple的转换映射关系是独立于内部主机所发出的UDP报文中的目标地址及端口的，即与目标Tuple无关；而在Symmetric类型中，目标Tuple则成为了NAT设备建立转换关系的一个重要考量：只有来自于同一个内部Tuple、且针对同一目标Tuple的请求才被NAT转换至同一个外部Tuple，否则的话，NAT将为之分配一个新的外部Tuple。，



**隧道技术**：一种将一个网络的数据包封装在另一个网络的数据包中的技术，以便在公共网络上传输私有数据。隧道技术通常用于实现虚拟专用网络（VPN）或远程访问等应用。在NAT环境中，隧道技术可以用于穿透NAT，以便让私有网络中的设备能够通过NAT访问外部网络。

**P2P（点对点）**：一种网络技术，它允许网络中的设备之间直接通信，而不是通过中央服务器进行中转。在NAT环境中，P2P技术可以用于建立穿越NAT的直接连接，以便私有网络中的设备能够相互通信。P2P技术可以用于多种应用，例如文件共享、在线游戏、VoIP等。



### 代理

​		在编程中，代理（Proxy）是一种设计模式，用于在客户端和目标对象之间插入一个中间层，控制对目标对象的访问。代理模式提供了一种方式，可以在不改变原有代码的情况下，增加额外的功能或限制对目标对象的访问。

#### 代理模式的工作原理：

代理模式涉及三个角色：

1. **代理类**：代理类负责在客户端和目标对象之间进行通信。它包含了与目标对象相同的接口，以便客户端可以像调用目标对象一样调用代理。代理类还可以在客户端和目标对象之间添加额外的操作，例如记录日志、性能监控等。
2. **客户端**：客户端通过代理类来访问目标对象。客户端不需要知道代理的存在，它只需要调用代理的方法即可。
3. **目标对象**：这是被代理的对象，客户端通过代理来访问它。

#### 正向代理和反向代理：

​		<u>正向代理和反向代理是代理服务器的一种分类方式。</u>

​		**正向代理**是一个<u>位于客户端和原始服务器（origin server）之间的服务器</u>。为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标（原始服务器），然后代理向原始服务器转交请求并将获得的内容返回给客户端。它根据客户端的请求，从后端的服务器（如Web服务器）上获取资源，然后再将这些资源返回给客户端。正向代理的运行依赖于客户端的配置，通常需要客户端进行一些特别的设置才能使用正向代理。

**学姐注**：正向代理：你是客户端，你找一个中间人替你访问服务端。



​		**反向代理**则是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端。此时代理服务器对外就表现为一个反向代理服务器。反向代理隐藏了服务器的真实IP，提供了负载均衡和安全防护等作用。它位于服务器端，作为服务器的代理使用，而不是客户端。

**学姐注**：反向代理：你是服务端，找一个中间人替你接收客户端的请求。

- 一种是中间人主动向服务端发起的，比如nginx，caddy
- 还有一种是服务端主动向中间人发起的，比如ngrok（内网穿透）



​		总的来说，正向代理和反向代理的主要区别在于一个运行在客户端，一个运行在服务器端。两者都能提高访问速度，是常用的网络技术。

